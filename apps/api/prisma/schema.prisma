generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USERS ==============

model User {
  id          String   @id @default(cuid())
  telegramId  String   @unique @map("telegram_id")
  username    String?
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")

  // Balance (only $FORTUNE, USDT converts on deposit/withdrawal)
  fortuneBalance  Decimal @default(0) @map("fortune_balance") @db.Decimal(20, 8)
  referralBalance Decimal @default(0) @map("referral_balance") @db.Decimal(20, 8)

  // Fund source tracking (for correct taxation on withdrawal)
  totalFreshDeposits   Decimal @default(0) @map("total_fresh_deposits") @db.Decimal(20, 8)   // Cumulative fresh USDT â†’ FORTUNE
  totalProfitCollected Decimal @default(0) @map("total_profit_collected") @db.Decimal(20, 8) // Cumulative profit from machines

  // Progression
  maxTierReached  Int     @default(0) @map("max_tier_reached")   // For tax rate calculation (updated on purchase)
  maxTierUnlocked Int     @default(1) @map("max_tier_unlocked")  // For tier access (updated on machine expire)
  currentTaxRate  Decimal @default(0.5) @map("current_tax_rate") @db.Decimal(5, 4)

  // Referral
  referralCode String  @unique @map("referral_code")
  referredById String? @map("referred_by_id")
  referredBy   User?   @relation("Referrals", fields: [referredById], references: [id])
  referrals    User[]  @relation("Referrals")

  // Wheel
  freeSpinsRemaining Int       @default(0) @map("free_spins_remaining")
  lastSpinAt         DateTime? @map("last_spin_at")

  // Relations
  machines          Machine[]
  transactions      Transaction[]
  depositAddresses  DepositAddress[]
  deposits          Deposit[]
  withdrawals       Withdrawal[]
  walletConnections WalletConnection[]
  referralBonuses   ReferralBonus[]    @relation("ReferralReceiver")
  referralBonusesSent ReferralBonus[]  @relation("ReferralSource")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// ============== MACHINES ==============

model Machine {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])
  tier   Int

  // Financials
  purchasePrice Decimal @map("purchase_price") @db.Decimal(20, 8)
  totalYield    Decimal @map("total_yield") @db.Decimal(20, 8)
  profitAmount  Decimal @map("profit_amount") @db.Decimal(20, 8)

  // Lifecycle
  lifespanDays Int      @map("lifespan_days")
  startedAt    DateTime @map("started_at")
  expiresAt    DateTime @map("expires_at")

  // Income tracking (on-demand calculation)
  ratePerSecond    Decimal  @map("rate_per_second") @db.Decimal(20, 12)
  accumulatedIncome Decimal @default(0) @map("accumulated_income") @db.Decimal(20, 8)
  lastCalculatedAt DateTime @default(now()) @map("last_calculated_at")

  // Payout tracking (profit first, then principal)
  profitPaidOut    Decimal @default(0) @map("profit_paid_out") @db.Decimal(20, 8)
  principalPaidOut Decimal @default(0) @map("principal_paid_out") @db.Decimal(20, 8)

  // Reinvest tracking
  reinvestRound        Int     @default(1) @map("reinvest_round")
  profitReductionRate  Decimal @default(0) @map("profit_reduction_rate") @db.Decimal(5, 4)

  // Coin box
  coinBoxLevel    Int     @default(1) @map("coin_box_level")
  coinBoxCapacity Decimal @map("coin_box_capacity") @db.Decimal(20, 8)
  coinBoxCurrent  Decimal @default(0) @map("coin_box_current") @db.Decimal(20, 8)

  // Fortune's Gamble (Risky Collect)
  fortuneGambleLevel Int @default(0) @map("fortune_gamble_level")

  // Auto Collect module
  autoCollectEnabled     Boolean   @default(false) @map("auto_collect_enabled")
  autoCollectPurchasedAt DateTime? @map("auto_collect_purchased_at")

  status MachineStatus @default(active)

  // Fund source tracking
  fundSource FundSource?

  // Relations
  transactions Transaction[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("machines")
}

enum MachineStatus {
  active
  expired
  sold_early
  sold_auction    // Sold via auction (P2P)
  sold_pawnshop   // Sold to system via pawnshop
  listed_auction  // Currently listed on auction (waiting for buyer)
}

// ============== FUND SOURCES ==============
// Critical for correct taxation: tracks where funds came from

model FundSource {
  id        String @id @default(cuid())
  machineId String @unique @map("machine_id")
  machine   Machine @relation(fields: [machineId], references: [id])

  // Tracks where FORTUNE came from (for tax calculation on withdrawal)
  freshDepositAmount  Decimal @map("fresh_deposit_amount") @db.Decimal(20, 8)  // From USDT deposits
  profitDerivedAmount Decimal @map("profit_derived_amount") @db.Decimal(20, 8) // From machine profits
  sourceMachineIds    String[] @map("source_machine_ids")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("fund_sources")
}

// ============== TRANSACTIONS ==============

model Transaction {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])
  machineId String? @map("machine_id")
  machine   Machine? @relation(fields: [machineId], references: [id])

  type     TransactionType
  amount   Decimal @db.Decimal(20, 8)
  currency Currency

  // Tax info
  taxAmount Decimal @default(0) @map("tax_amount") @db.Decimal(20, 8)
  taxRate   Decimal @default(0) @map("tax_rate") @db.Decimal(5, 4)
  netAmount Decimal @map("net_amount") @db.Decimal(20, 8)

  // Source tracking (for tax calculation)
  fromFreshDeposit Decimal @default(0) @map("from_fresh_deposit") @db.Decimal(20, 8)
  fromProfit       Decimal @default(0) @map("from_profit") @db.Decimal(20, 8)

  // Blockchain (for deposits/withdrawals)
  chain  String?
  txHash String? @map("tx_hash")

  // Fortune's Gamble metadata (for risky collect analytics)
  gambleWon    Boolean? @map("gamble_won")
  gambleChance Decimal? @map("gamble_chance") @db.Decimal(5, 4)

  status TransactionStatus @default(pending)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("transactions")
}

enum TransactionType {
  deposit
  withdrawal
  machine_purchase
  machine_income
  machine_income_risky
  machine_early_sell
  machine_auction_list     // Listed machine on auction
  machine_auction_sale     // Sold machine via auction (seller receives)
  machine_auction_cancel   // Cancelled auction listing
  machine_pawnshop_sale    // Sold machine to pawnshop
  referral_bonus
  wheel_prize
  upgrade_purchase
}

enum TransactionStatus {
  pending
  completed
  failed
  cancelled
}

enum Currency {
  FORTUNE
  USDT
}

// ============== DEPOSITS ==============

model Deposit {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])

  // Deposit method
  method      DepositMethod

  chain       Chain           @default(solana)
  currency    DepositCurrency
  txSignature String          @unique @map("tx_signature")

  // Original amount in native currency
  amount      Decimal @db.Decimal(20, 8)
  // Converted to USD (this is what gets credited)
  amountUsd   Decimal @default(0) @map("amount_usd") @db.Decimal(20, 8)

  // Exchange rate at deposit time
  rateToUsd   Decimal? @map("rate_to_usd") @db.Decimal(20, 8)

  // For wallet connect: memo used in transaction
  memo        String?

  status       DepositStatus @default(pending)
  slot         BigInt?
  confirmedAt  DateTime?     @map("confirmed_at")
  creditedAt   DateTime?     @map("credited_at")
  errorMessage String?       @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([memo])
  @@map("deposits")
}

enum DepositMethod {
  wallet_connect
  deposit_address
}

enum DepositCurrency {
  SOL
  USDT_SOL
  FORTUNE
}

enum DepositStatus {
  pending     // Detected, waiting confirmation
  confirmed   // Finalized on chain
  credited    // Balance updated
  failed      // Error during processing
}

// ============== WALLET CONNECTIONS ==============
// Links user's external wallet for Wallet Connect deposits

model WalletConnection {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])

  chain         Chain
  walletAddress String @map("wallet_address")

  // Last connection time
  connectedAt   DateTime @default(now()) @map("connected_at")

  @@unique([userId, chain])
  @@unique([walletAddress, chain])
  @@index([walletAddress])
  @@map("wallet_connections")
}

// ============== DEPOSIT ADDRESSES ==============
// HD Wallet derived addresses for deposits from exchanges

model DepositAddress {
  id       String @id @default(cuid())
  userId   String @map("user_id")
  user     User   @relation(fields: [userId], references: [id])

  chain    Chain
  address  String
  isActive Boolean @default(true) @map("is_active")

  // HD Wallet derivation
  derivationIndex Int @map("derivation_index")

  // Helius webhook tracking
  webhookId String? @map("webhook_id")

  // Sweep tracking
  lastSweptAt DateTime? @map("last_swept_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, chain])
  @@index([address])
  @@map("deposit_addresses")
}

enum Chain {
  ton
  solana
  bsc
  tron
}

// ============== SYSTEM SETTINGS ==============
// Singleton table for global configuration

model SystemSettings {
  id              String @id @default("default")

  // Max tier available for purchase globally (without progression)
  // Users can buy tiers 1..maxGlobalTier immediately
  // After buying maxTierReached, next tier unlocks as usual
  maxGlobalTier   Int    @default(1) @map("max_global_tier")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// ============== REFERRAL BONUSES ==============

model ReferralBonus {
  id         String @id @default(cuid())
  receiverId String @map("receiver_id")
  receiver   User   @relation("ReferralReceiver", fields: [receiverId], references: [id])
  sourceId   String @map("source_id")
  source     User   @relation("ReferralSource", fields: [sourceId], references: [id])

  level  Int // 1, 2, or 3
  rate   Decimal @db.Decimal(5, 4) // 0.05, 0.03, 0.01
  amount Decimal @db.Decimal(20, 8)

  // What triggered this bonus
  machineId   String  @map("machine_id")   // machine purchase that triggered
  freshAmount Decimal @map("fresh_amount") @db.Decimal(20, 8) // fresh_usdt part of purchase

  createdAt DateTime @default(now()) @map("created_at")

  @@index([receiverId])
  @@index([sourceId])
  @@map("referral_bonuses")
}

// ============== AUCTION LISTINGS ==============
// FIFO queue for P2P machine sales

model AuctionListing {
  id        String @id @default(cuid())
  machineId String @unique @map("machine_id")
  sellerId  String @map("seller_id")

  tier Int // Denormalized for quick queue lookup

  // Snapshot at listing time (for commission calculation)
  wearPercentAtListing    Decimal @map("wear_percent_at_listing") @db.Decimal(5, 2)
  commissionRateAtListing Decimal @map("commission_rate_at_listing") @db.Decimal(5, 4)
  expectedPayout          Decimal @map("expected_payout") @db.Decimal(20, 8)

  // Upgrades to transfer (buyer gets new machine + these upgrades)
  coinBoxLevelAtListing     Int     @map("coin_box_level_at_listing")
  fortuneGambleLevelAtListing Int   @map("fortune_gamble_level_at_listing")
  autoCollectAtListing      Boolean @map("auto_collect_at_listing")

  status AuctionListingStatus @default(pending)

  // Sale info (filled when sold)
  buyerId  String?   @map("buyer_id")
  soldAt   DateTime? @map("sold_at")
  newMachineId String? @map("new_machine_id") // Machine created for buyer

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tier, status, createdAt]) // For FIFO queue by tier
  @@index([sellerId])
  @@index([status])
  @@map("auction_listings")
}

enum AuctionListingStatus {
  pending   // Waiting for buyer
  sold      // Successfully sold
  cancelled // Seller cancelled
  expired   // Machine expired while listed
}

// ============== WITHDRAWALS ==============
// Two methods: wallet_connect (atomic tx) and manual_address (instant send)

model Withdrawal {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])

  // Method
  method    WithdrawalMethod

  // Destination
  chain           Chain    @default(solana)
  currency        WithdrawalCurrency  // Only USDT_SOL for now
  walletAddress   String   @map("wallet_address")

  // Amounts (all in USD, fortuneBalance = USD)
  requestedAmount Decimal  @map("requested_amount") @db.Decimal(20, 8)  // Amount requested

  // Tax breakdown (profit taxed first, fresh = 0%)
  fromFreshDeposit Decimal @map("from_fresh_deposit") @db.Decimal(20, 8)  // From fresh (0% tax)
  fromProfit       Decimal @map("from_profit") @db.Decimal(20, 8)         // From profit (taxed)
  taxAmount        Decimal @map("tax_amount") @db.Decimal(20, 8)          // Tax amount
  taxRate          Decimal @map("tax_rate") @db.Decimal(5, 4)             // Rate at withdrawal

  // Final amounts
  netAmount        Decimal @map("net_amount") @db.Decimal(20, 8)          // After tax (USD)
  usdtAmount       Decimal @map("usdt_amount") @db.Decimal(20, 8)         // USDT to send (= netAmount)

  // For wallet_connect: fee paid by user in SOL
  feeSolAmount     Decimal? @map("fee_sol_amount") @db.Decimal(20, 9)

  // Transaction
  txSignature      String? @unique @map("tx_signature")

  // Status
  status           WithdrawalStatus @default(pending)
  errorMessage     String?          @map("error_message")

  // Timestamps
  processedAt      DateTime?        @map("processed_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("withdrawals")
}

enum WithdrawalMethod {
  wallet_connect  // Atomic tx: user pays SOL fee, receives USDT in one tx
  manual_address  // User enters address, hot wallet sends USDT instantly
}

enum WithdrawalCurrency {
  USDT_SOL
}

enum WithdrawalStatus {
  pending      // Created, awaiting processing
  processing   // Being sent
  completed    // Successfully sent
  failed       // Error occurred
  cancelled    // Cancelled by user
}
