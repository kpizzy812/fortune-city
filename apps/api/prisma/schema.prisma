generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USERS ==============

model User {
  id          String   @id @default(cuid())

  // Auth providers (at least one required)
  telegramId  String?  @unique @map("telegram_id")
  email       String?  @unique
  supabaseId  String?  @unique @map("supabase_id")
  emailVerifiedAt DateTime? @map("email_verified_at")
  web3Address String?  @unique @map("web3_address") // Solana wallet address

  // Profile (can come from any provider)
  username    String?
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  avatarUrl   String?  @map("avatar_url")
  language    String?  @default("en") // ru, en â€” from Telegram language_code

  // Balance (only $FORTUNE, USDT converts on deposit/withdrawal)
  fortuneBalance  Decimal @default(0) @map("fortune_balance") @db.Decimal(20, 8)
  referralBalance Decimal @default(0) @map("referral_balance") @db.Decimal(20, 8)
  bonusFortune    Decimal @default(0) @map("bonus_fortune") @db.Decimal(20, 8)    // Prelaunch wheel winnings (can only be spent on machine purchase)

  // Fund source tracking (for correct taxation on withdrawal)
  totalFreshDeposits   Decimal @default(0) @map("total_fresh_deposits") @db.Decimal(20, 8)   // Cumulative fresh USDT â†’ FORTUNE
  totalProfitCollected Decimal @default(0) @map("total_profit_collected") @db.Decimal(20, 8) // Cumulative profit from machines

  // Progression
  maxTierReached  Int     @default(0) @map("max_tier_reached")   // For tax rate calculation (updated on purchase)
  maxTierUnlocked Int     @default(1) @map("max_tier_unlocked")  // For tier access (updated on machine expire)
  currentTaxRate  Decimal @default(0.5) @map("current_tax_rate") @db.Decimal(5, 4)

  // Referral
  referralCode String  @unique @map("referral_code")
  referredById String? @map("referred_by_id")
  referredBy   User?   @relation("Referrals", fields: [referredById], references: [id])
  referrals    User[]  @relation("Referrals")

  // Wheel
  freeSpinsRemaining Int       @default(0) @map("free_spins_remaining")
  lastSpinAt         DateTime? @map("last_spin_at")

  // Ban status (admin panel)
  isBanned     Boolean   @default(false) @map("is_banned")
  bannedAt     DateTime? @map("banned_at")
  bannedReason String?   @map("banned_reason")

  // Telegram Bot connection (for notifications)
  telegramChatId               String?   @map("telegram_chat_id")
  telegramNotificationsEnabled Boolean   @default(false) @map("telegram_notifications_enabled")
  telegramBotConnectedAt       DateTime? @map("telegram_bot_connected_at")

  // Referral milestones
  taxDiscount  Decimal @default(0) @map("tax_discount") @db.Decimal(5, 4) // Personal tax discount from milestones

  // OG status (prelaunch registration)
  isOG Boolean @default(false) @map("is_og")

  // Fame (progression resource)
  fame            Int       @default(0)
  totalFameEarned Int       @default(0) @map("total_fame_earned")
  loginStreak     Int       @default(0) @map("login_streak")
  lastLoginDate   DateTime? @map("last_login_date")

  // Relations
  machines            Machine[]
  fameTransactions    FameTransaction[]
  transactions        Transaction[]
  depositAddresses    DepositAddress[]
  deposits            Deposit[]
  withdrawals         Withdrawal[]
  walletConnections   WalletConnection[]
  referralBonuses     ReferralBonus[]    @relation("ReferralReceiver")
  referralBonusesSent ReferralBonus[]    @relation("ReferralSource")
  referralMilestones  ReferralMilestone[]
  notifications       Notification[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// ============== MACHINES ==============

model Machine {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])
  tier   Int

  // Financials
  purchasePrice Decimal @map("purchase_price") @db.Decimal(20, 8)
  totalYield    Decimal @map("total_yield") @db.Decimal(20, 8)
  profitAmount  Decimal @map("profit_amount") @db.Decimal(20, 8)

  // Lifecycle
  lifespanDays Int      @map("lifespan_days")
  startedAt    DateTime @map("started_at")
  expiresAt    DateTime @map("expires_at")

  // Income tracking (on-demand calculation)
  ratePerSecond    Decimal  @map("rate_per_second") @db.Decimal(20, 12)
  accumulatedIncome Decimal @default(0) @map("accumulated_income") @db.Decimal(20, 8)
  lastCalculatedAt DateTime @default(now()) @map("last_calculated_at")

  // Payout tracking (profit first, then principal)
  profitPaidOut    Decimal @default(0) @map("profit_paid_out") @db.Decimal(20, 8)
  principalPaidOut Decimal @default(0) @map("principal_paid_out") @db.Decimal(20, 8)

  // Reinvest tracking
  reinvestRound        Int     @default(1) @map("reinvest_round")
  profitReductionRate  Decimal @default(0) @map("profit_reduction_rate") @db.Decimal(5, 4)

  // Coin box
  coinBoxLevel    Int     @default(1) @map("coin_box_level")
  coinBoxCapacity Decimal @map("coin_box_capacity") @db.Decimal(20, 8)
  coinBoxCurrent  Decimal @default(0) @map("coin_box_current") @db.Decimal(20, 8)

  // Fortune's Gamble (Risky Collect)
  fortuneGambleLevel Int @default(0) @map("fortune_gamble_level")

  // Auto Collect module
  autoCollectEnabled     Boolean   @default(false) @map("auto_collect_enabled")
  autoCollectPurchasedAt DateTime? @map("auto_collect_purchased_at")

  status MachineStatus @default(active)

  // Fame tracking (lazy calculation at collect time)
  fameGenerated        Int      @default(0) @map("fame_generated")
  lastFameCalculatedAt DateTime @default(now()) @map("last_fame_calculated_at")

  // Overclock (income boost for next collect, 0 = none, 1.2/1.5/2.0 = active)
  overclockMultiplier Decimal @default(0) @map("overclock_multiplier") @db.Decimal(3, 1)

  // Fund source tracking
  fundSource FundSource?

  // Relations
  transactions Transaction[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("machines")
}

enum MachineStatus {
  active
  frozen          // Prelaunch: purchased but not generating income yet
  expired
  sold_early
  sold_auction    // Sold via auction (P2P)
  sold_pawnshop   // Sold to system via pawnshop
  listed_auction  // Currently listed on auction (waiting for buyer)
}

// ============== FUND SOURCES ==============
// Critical for correct taxation: tracks where funds came from

model FundSource {
  id        String @id @default(cuid())
  machineId String @unique @map("machine_id")
  machine   Machine @relation(fields: [machineId], references: [id])

  // Tracks where FORTUNE came from (for tax calculation on withdrawal)
  freshDepositAmount  Decimal @map("fresh_deposit_amount") @db.Decimal(20, 8)  // From USDT deposits
  profitDerivedAmount Decimal @map("profit_derived_amount") @db.Decimal(20, 8) // From machine profits
  sourceMachineIds    String[] @map("source_machine_ids")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("fund_sources")
}

// ============== TRANSACTIONS ==============

model Transaction {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])
  machineId String? @map("machine_id")
  machine   Machine? @relation(fields: [machineId], references: [id])

  type     TransactionType
  amount   Decimal @db.Decimal(20, 8)
  currency Currency

  // Tax info
  taxAmount Decimal @default(0) @map("tax_amount") @db.Decimal(20, 8)
  taxRate   Decimal @default(0) @map("tax_rate") @db.Decimal(5, 4)
  netAmount Decimal @map("net_amount") @db.Decimal(20, 8)

  // Source tracking (for tax calculation)
  fromFreshDeposit Decimal @default(0) @map("from_fresh_deposit") @db.Decimal(20, 8)
  fromProfit       Decimal @default(0) @map("from_profit") @db.Decimal(20, 8)

  // Blockchain (for deposits/withdrawals)
  chain  String?
  txHash String? @map("tx_hash")

  // Fortune's Gamble metadata (for risky collect analytics)
  gambleWon    Boolean? @map("gamble_won")
  gambleChance Decimal? @map("gamble_chance") @db.Decimal(5, 4)

  status TransactionStatus @default(pending)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("transactions")
}

enum TransactionType {
  deposit
  withdrawal
  machine_purchase
  machine_income
  machine_income_risky
  machine_early_sell
  machine_auction_list     // Listed machine on auction
  machine_auction_sale     // Sold machine via auction (seller receives)
  machine_auction_cancel   // Cancelled auction listing
  machine_pawnshop_sale    // Sold machine to pawnshop
  referral_bonus
  wheel_prize
  upgrade_purchase
  collector_hire           // Hired auto-collect worker
  collector_salary         // Auto-collect worker salary deduction
  overclock_purchase       // Purchased overclock boost for machine
}

enum TransactionStatus {
  pending
  completed
  failed
  cancelled
}

enum Currency {
  FORTUNE
  USDT
}

// ============== FAME TRANSACTIONS ==============

model FameTransaction {
  id           String     @id @default(cuid())
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id])
  amount       Int        // + earn, - spend
  balanceAfter Int        @map("balance_after")
  source       FameSource
  description  String?
  machineId    String?    @map("machine_id")
  createdAt    DateTime   @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([source])
  @@map("fame_transactions")
}

enum FameSource {
  machine_passive
  manual_collect
  daily_login
  machine_purchase
  tier_unlock
  collector_hire
  overclock_purchase
  admin_adjustment
}

// ============== DEPOSITS ==============

model Deposit {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])

  // Deposit method
  method      DepositMethod

  chain       Chain           @default(solana)
  currency    DepositCurrency
  txSignature String          @unique @map("tx_signature")

  // Original amount in native currency
  amount      Decimal @db.Decimal(20, 8)
  // Converted to USD (this is what gets credited)
  amountUsd   Decimal @default(0) @map("amount_usd") @db.Decimal(20, 8)

  // Exchange rate at deposit time
  rateToUsd   Decimal? @map("rate_to_usd") @db.Decimal(20, 8)

  // For wallet connect: memo used in transaction
  memo        String?

  status       DepositStatus @default(pending)
  slot         BigInt?
  confirmedAt  DateTime?     @map("confirmed_at")
  creditedAt   DateTime?     @map("credited_at")
  errorMessage String?       @map("error_message")

  // ===== Other Crypto support =====
  otherCryptoNetwork  String?   @map("other_crypto_network")  // "BEP20" | "TON"
  otherCryptoToken    String?   @map("other_crypto_token")    // "USDT" | "BNB" | "TON"

  // Admin approval fields
  adminNotes         String?    @map("admin_notes")
  processedBy        String?    @map("processed_by")          // admin username
  processedAt        DateTime?  @map("processed_at")
  rejectionReason    String?    @map("rejection_reason")

  // Claimed amount (may differ from actual)
  claimedAmount      Decimal?   @map("claimed_amount") @db.Decimal(20, 8)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([memo])
  @@map("deposits")
}

enum DepositMethod {
  wallet_connect
  deposit_address
  other_crypto     // Manual approval through admin panel
}

enum DepositCurrency {
  SOL
  USDT_SOL
  FORTUNE
}

enum DepositStatus {
  pending     // Detected, waiting confirmation
  confirmed   // Finalized on chain
  credited    // Balance updated
  failed      // Error during processing
  rejected    // Rejected by admin
}

// ============== WALLET CONNECTIONS ==============
// Links user's external wallet for Wallet Connect deposits

model WalletConnection {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])

  chain         Chain
  walletAddress String @map("wallet_address")

  // Last connection time
  connectedAt   DateTime @default(now()) @map("connected_at")

  @@unique([userId, chain])
  @@unique([walletAddress, chain])
  @@index([walletAddress])
  @@map("wallet_connections")
}

// ============== DEPOSIT ADDRESSES ==============
// HD Wallet derived addresses for deposits from exchanges

model DepositAddress {
  id       String @id @default(cuid())
  userId   String @map("user_id")
  user     User   @relation(fields: [userId], references: [id])

  chain    Chain
  address  String
  isActive Boolean @default(true) @map("is_active")

  // HD Wallet derivation
  derivationIndex Int @map("derivation_index")

  // Helius webhook tracking
  webhookId String? @map("webhook_id")

  // Sweep tracking
  lastSweptAt DateTime? @map("last_swept_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, chain])
  @@index([address])
  @@map("deposit_addresses")
}

enum Chain {
  ton
  solana
  bsc
  tron
}

// ============== TIER CONFIG ==============
// Dynamic tier configuration (replaces hardcoded MACHINE_TIERS)

model TierConfig {
  id              String   @id @default(cuid())
  tier            Int      @unique
  name            String                          // "RUSTY LEVER"
  emoji           String                          // "ðŸŸ¤"
  price           Decimal  @db.Decimal(20, 2)     // 10
  lifespanDays    Int      @map("lifespan_days")  // 7
  yieldPercent    Int      @map("yield_percent")  // 135
  imageUrl        String?  @map("image_url")

  // Admin panel controls
  isVisible           Boolean  @default(true) @map("is_visible")              // Show in shop
  isPubliclyAvailable Boolean  @default(false) @map("is_publicly_available")  // Available without progression
  sortOrder           Int      @default(0) @map("sort_order")                 // Display order

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("tier_configs")
}

// ============== SYSTEM SETTINGS ==============
// Singleton table for global configuration

model SystemSettings {
  id              String @id @default("default")

  // Prelaunch mode
  isPrelaunch     Boolean   @default(false) @map("is_prelaunch")
  prelaunchEndsAt DateTime? @map("prelaunch_ends_at")   // Countdown timer for frontend

  // Max tier available for purchase globally (without progression)
  maxGlobalTier   Int    @default(1) @map("max_global_tier")

  // Minimum amounts (JSON for different currencies)
  minDepositAmounts   Json @default("{\"SOL\":0.01,\"USDT_SOL\":1,\"FORTUNE\":10}") @map("min_deposit_amounts")
  minWithdrawalAmount Decimal @default(5) @map("min_withdrawal_amount") @db.Decimal(20, 2)

  // Fees
  walletConnectFeeSol Decimal @default(0.003) @map("wallet_connect_fee_sol") @db.Decimal(10, 6)
  pawnshopCommission  Decimal @default(0.10) @map("pawnshop_commission") @db.Decimal(5, 4)

  // Tax rates by tier (JSON: {tierNumber: rate})
  taxRatesByTier      Json @default("{\"1\":0.5,\"2\":0.5,\"3\":0.4,\"4\":0.4,\"5\":0.3,\"6\":0.3,\"7\":0.2,\"8\":0.2,\"9\":0.2,\"10\":0.1}") @map("tax_rates_by_tier")

  // Referral rates by level (JSON: {level: rate})
  referralRates       Json @default("{\"1\":0.05,\"2\":0.03,\"3\":0.01}") @map("referral_rates")

  // Reinvest reduction by round (JSON: {round: rate})
  reinvestReduction   Json @default("{\"1\":0,\"2\":0.35,\"3\":0.50,\"4\":0.60,\"5\":0.70,\"6\":0.80,\"7\":0.90}") @map("reinvest_reduction")

  // Auction commissions by wear% (JSON: {wearPercent: commission})
  auctionCommissions  Json @default("{\"20\":0.10,\"40\":0.20,\"60\":0.35,\"80\":0.55,\"100\":0.75}") @map("auction_commissions")

  // Early sell commissions by progress% (JSON: {progressPercent: commission})
  earlySellCommissions Json @default("{\"20\":0.20,\"40\":0.35,\"60\":0.55,\"80\":0.75,\"100\":0.90}") @map("early_sell_commissions")

  // Fortune's Gamble
  gambleWinMultiplier  Decimal @default(2.0) @map("gamble_win_multiplier") @db.Decimal(5, 2)
  gambleLoseMultiplier Decimal @default(0.5) @map("gamble_lose_multiplier") @db.Decimal(5, 2)
  gambleLevels         Json @default("[{\"level\":0,\"winChance\":0.1333,\"costPercent\":0},{\"level\":1,\"winChance\":0.1533,\"costPercent\":3},{\"level\":2,\"winChance\":0.1733,\"costPercent\":6},{\"level\":3,\"winChance\":0.1867,\"costPercent\":10}]") @map("gamble_levels")

  // Coin Box - fixed capacity for all machines
  coinBoxCapacityHours Int @default(12) @map("coin_box_capacity_hours")

  // Collector (Auto Collect) - hire cost (% of gross profit) + salary
  collectorHirePercent   Decimal @default(10) @map("collector_hire_percent") @db.Decimal(5, 2) // 10% of gross profit
  collectorSalaryPercent Decimal @default(5) @map("collector_salary_percent") @db.Decimal(5, 2) // 5% of each collect

  // Fortune Wheel settings
  wheelBetAmount     Decimal @default(1) @map("wheel_bet_amount") @db.Decimal(10, 2)  // $1 per spin
  wheelMultipliers   Json    @default("[1, 5, 10, 25, 50]") @map("wheel_multipliers") // Multi-spin options
  wheelFreeSpinsBase Int     @default(1) @map("wheel_free_spins_base")               // Free spins per day
  wheelFreeSpinsPerRef Int   @default(1) @map("wheel_free_spins_per_ref")            // Per active referral
  wheelJackpotCap    Decimal @default(1000) @map("wheel_jackpot_cap") @db.Decimal(20, 2)
  wheelBurnRate      Decimal @default(0.80) @map("wheel_burn_rate") @db.Decimal(5, 4)   // 80% of losses burn
  wheelPoolRate      Decimal @default(0.20) @map("wheel_pool_rate") @db.Decimal(5, 4)   // 20% to jackpot

  // Wheel sectors: [{sector, chance, multiplier}]
  wheelSectors Json @default("[{\"sector\":\"5x\",\"chance\":0.01,\"multiplier\":5},{\"sector\":\"2x\",\"chance\":0.05,\"multiplier\":2},{\"sector\":\"1.5x\",\"chance\":0.08,\"multiplier\":1.5},{\"sector\":\"1x\",\"chance\":0.12,\"multiplier\":1},{\"sector\":\"0.5x\",\"chance\":0.18,\"multiplier\":0.5},{\"sector\":\"0.2x\",\"chance\":0.22,\"multiplier\":0.2},{\"sector\":\"empty\",\"chance\":0.33,\"multiplier\":0},{\"sector\":\"jackpot\",\"chance\":0.01,\"multiplier\":0}]") @map("wheel_sectors")

  // Fame system settings
  famePerHourByTier     Json @default("{\"1\":2,\"2\":3,\"3\":5,\"4\":8,\"5\":12,\"6\":18,\"7\":28,\"8\":42,\"9\":65,\"10\":100}") @map("fame_per_hour_by_tier")
  famePerManualCollect  Int  @default(10) @map("fame_per_manual_collect")
  fameDailyLogin        Int  @default(15) @map("fame_daily_login")
  fameStreakBonus       Int  @default(2) @map("fame_streak_bonus")
  fameStreakCap         Int  @default(20) @map("fame_streak_cap")
  famePurchaseByTier    Json @default("{\"1\":15,\"2\":25,\"3\":40,\"4\":60,\"5\":100,\"6\":150,\"7\":250,\"8\":400,\"9\":600,\"10\":1000}") @map("fame_purchase_by_tier")
  fameUpgradeMultiplier Int  @default(2) @map("fame_upgrade_multiplier")
  fameUnlockCostByTier  Json @default("{\"2\":250,\"3\":500,\"4\":1000,\"5\":2000,\"6\":4000,\"7\":7500,\"8\":14000,\"9\":26000,\"10\":45000}") @map("fame_unlock_cost_by_tier")

  // Overclock prices (JSON: {tier: {level: {fortune, fame}}})
  overclockFortunePrices Json @default("{\"1\":{\"1.2\":0.5,\"1.5\":1,\"2\":2},\"2\":{\"1.2\":0.5,\"1.5\":1.5,\"2\":3},\"3\":{\"1.2\":1,\"1.5\":3,\"2\":6},\"4\":{\"1.2\":2,\"1.5\":5,\"2\":12},\"5\":{\"1.2\":5,\"1.5\":12,\"2\":30},\"6\":{\"1.2\":12,\"1.5\":35,\"2\":80},\"7\":{\"1.2\":35,\"1.5\":100,\"2\":250},\"8\":{\"1.2\":100,\"1.5\":300,\"2\":800},\"9\":{\"1.2\":350,\"1.5\":1000,\"2\":2500},\"10\":{\"1.2\":1000,\"1.5\":3500,\"2\":9000}}") @map("overclock_fortune_prices")
  overclockFamePrices    Json @default("{\"1\":{\"1.2\":12,\"1.5\":30,\"2\":70},\"2\":{\"1.2\":18,\"1.5\":45,\"2\":100},\"3\":{\"1.2\":30,\"1.5\":75,\"2\":180},\"4\":{\"1.2\":50,\"1.5\":120,\"2\":290},\"5\":{\"1.2\":70,\"1.5\":175,\"2\":430},\"6\":{\"1.2\":110,\"1.5\":260,\"2\":650},\"7\":{\"1.2\":170,\"1.5\":400,\"2\":1000},\"8\":{\"1.2\":250,\"1.5\":600,\"2\":1500},\"9\":{\"1.2\":400,\"1.5\":950,\"2\":2400},\"10\":{\"1.2\":600,\"1.5\":1500,\"2\":3600}}") @map("overclock_fame_prices")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// ============== AUDIT LOG ==============
// Admin panel action history

model AuditLog {
  id          String   @id @default(cuid())
  adminAction String   @map("admin_action")    // "user_banned", "settings_updated", "tier_created", etc
  resource    String                           // "user", "tier", "settings", "withdrawal"
  resourceId  String?  @map("resource_id")
  oldValue    Json?    @map("old_value")
  newValue    Json?    @map("new_value")
  ipAddress   String?  @map("ip_address")
  adminUser   String?  @map("admin_user")      // Admin username who performed action

  createdAt   DateTime @default(now()) @map("created_at")

  @@index([adminAction])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============== REFERRAL BONUSES ==============

model ReferralBonus {
  id         String @id @default(cuid())
  receiverId String @map("receiver_id")
  receiver   User   @relation("ReferralReceiver", fields: [receiverId], references: [id])
  sourceId   String @map("source_id")
  source     User   @relation("ReferralSource", fields: [sourceId], references: [id])

  level  Int // 1, 2, or 3
  rate   Decimal @db.Decimal(5, 4) // 0.05, 0.03, 0.01
  amount Decimal @db.Decimal(20, 8)

  // What triggered this bonus
  machineId   String  @map("machine_id")   // machine purchase that triggered
  freshAmount Decimal @map("fresh_amount") @db.Decimal(20, 8) // fresh_usdt part of purchase

  createdAt DateTime @default(now()) @map("created_at")

  @@index([receiverId])
  @@index([sourceId])
  @@map("referral_bonuses")
}

// ============== AUCTION LISTINGS ==============
// FIFO queue for P2P machine sales

model AuctionListing {
  id        String @id @default(cuid())
  machineId String @unique @map("machine_id")
  sellerId  String @map("seller_id")

  tier Int // Denormalized for quick queue lookup

  // Snapshot at listing time (for commission calculation)
  wearPercentAtListing    Decimal @map("wear_percent_at_listing") @db.Decimal(5, 2)
  commissionRateAtListing Decimal @map("commission_rate_at_listing") @db.Decimal(5, 4)
  expectedPayout          Decimal @map("expected_payout") @db.Decimal(20, 8)

  // Upgrades to transfer (buyer gets new machine + these upgrades)
  coinBoxLevelAtListing     Int     @map("coin_box_level_at_listing")
  fortuneGambleLevelAtListing Int   @map("fortune_gamble_level_at_listing")
  autoCollectAtListing      Boolean @map("auto_collect_at_listing")

  status AuctionListingStatus @default(pending)

  // Sale info (filled when sold)
  buyerId  String?   @map("buyer_id")
  soldAt   DateTime? @map("sold_at")
  newMachineId String? @map("new_machine_id") // Machine created for buyer

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tier, status, createdAt]) // For FIFO queue by tier
  @@index([sellerId])
  @@index([status])
  @@map("auction_listings")
}

enum AuctionListingStatus {
  pending   // Waiting for buyer
  sold      // Successfully sold
  cancelled // Seller cancelled
  expired   // Machine expired while listed
}

// ============== WITHDRAWALS ==============
// Two methods: wallet_connect (atomic tx) and manual_address (instant send)

model Withdrawal {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])

  // Method
  method    WithdrawalMethod

  // Destination
  chain           Chain    @default(solana)
  currency        WithdrawalCurrency  // Only USDT_SOL for now
  walletAddress   String   @map("wallet_address")

  // Amounts (all in USD, fortuneBalance = USD)
  requestedAmount Decimal  @map("requested_amount") @db.Decimal(20, 8)  // Amount requested

  // Tax breakdown (profit taxed first, fresh = 0%)
  fromFreshDeposit Decimal @map("from_fresh_deposit") @db.Decimal(20, 8)  // From fresh (0% tax)
  fromProfit       Decimal @map("from_profit") @db.Decimal(20, 8)         // From profit (taxed)
  taxAmount        Decimal @map("tax_amount") @db.Decimal(20, 8)          // Tax amount
  taxRate          Decimal @map("tax_rate") @db.Decimal(5, 4)             // Rate at withdrawal

  // Final amounts
  netAmount        Decimal @map("net_amount") @db.Decimal(20, 8)          // After tax (USD)
  usdtAmount       Decimal @map("usdt_amount") @db.Decimal(20, 8)         // USDT to send (= netAmount)

  // For wallet_connect: fee paid by user in SOL
  feeSolAmount     Decimal? @map("fee_sol_amount") @db.Decimal(20, 9)

  // Transaction
  txSignature      String? @unique @map("tx_signature")

  // Status
  status           WithdrawalStatus @default(pending)
  errorMessage     String?          @map("error_message")

  // Timestamps
  processedAt      DateTime?        @map("processed_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("withdrawals")
}

enum WithdrawalMethod {
  wallet_connect  // Atomic tx: user pays SOL fee, receives USDT in one tx
  manual_address  // User enters address, hot wallet sends USDT instantly
}

enum WithdrawalCurrency {
  USDT_SOL
}

enum WithdrawalStatus {
  pending      // Created, awaiting processing
  processing   // Being sent
  completed    // Successfully sent
  failed       // Error occurred
  cancelled    // Cancelled by user
}

// ============== FORTUNE WHEEL ==============

model WheelSpin {
  id        String @id @default(cuid())
  userId    String @map("user_id")

  // Bet info
  betAmount      Decimal @map("bet_amount") @db.Decimal(20, 8)       // Always $1 per spin
  spinCount      Int     @default(1) @map("spin_count")             // Multi-spin: 1/5/10/25/50
  totalBet       Decimal @map("total_bet") @db.Decimal(20, 8)       // betAmount * spinCount

  // Result (for single spin or summary for multi-spin)
  totalPayout    Decimal @map("total_payout") @db.Decimal(20, 8)    // Total won
  netResult      Decimal @map("net_result") @db.Decimal(20, 8)      // totalPayout - totalBet

  // Breakdown (JSON array of individual spin results for multi-spin)
  // [{sector: "2x", multiplier: 2, payout: 2}, ...]
  spinResults    Json    @map("spin_results")

  // Jackpot
  jackpotWon     Boolean @default(false) @map("jackpot_won")
  jackpotAmount  Decimal @default(0) @map("jackpot_amount") @db.Decimal(20, 8)

  // Burn/Pool tracking
  burnAmount     Decimal @default(0) @map("burn_amount") @db.Decimal(20, 8)    // 80% of losses
  poolAmount     Decimal @default(0) @map("pool_amount") @db.Decimal(20, 8)    // 20% of losses

  // Free spin usage
  freeSpinsUsed  Int     @default(0) @map("free_spins_used")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@index([jackpotWon])
  @@map("wheel_spins")
}

model WheelJackpot {
  id            String  @id @default("current")

  // Current pool
  currentPool   Decimal @default(0) @map("current_pool") @db.Decimal(20, 8)
  poolCap       Decimal @default(1000) @map("pool_cap") @db.Decimal(20, 8)

  // Statistics
  totalContributed Decimal @default(0) @map("total_contributed") @db.Decimal(20, 8)
  totalPaidOut     Decimal @default(0) @map("total_paid_out") @db.Decimal(20, 8)
  totalBurned      Decimal @default(0) @map("total_burned") @db.Decimal(20, 8)
  timesWon         Int     @default(0) @map("times_won")

  // Last winner info
  lastWinnerId     String?   @map("last_winner_id")
  lastWonAmount    Decimal?  @map("last_won_amount") @db.Decimal(20, 8)
  lastWonAt        DateTime? @map("last_won_at")

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("wheel_jackpot")
}

// ============== REFRESH TOKENS ==============
// For "Remember Me" functionality with 30-day sessions

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique // Hashed refresh token

  // Security metadata
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")

  // Expiration
  expiresAt DateTime @map("expires_at")

  // Tracking
  createdAt DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime @default(now()) @map("last_used_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model AdminRefreshToken {
  id        String   @id @default(cuid())
  username  String   // Admin username (not FK, since admin is not in DB)
  token     String   @unique // Hashed refresh token

  // Security metadata
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")

  // Expiration
  expiresAt DateTime @map("expires_at")

  // Tracking
  createdAt DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime @default(now()) @map("last_used_at")

  @@index([username])
  @@index([token])
  @@index([expiresAt])
  @@map("admin_refresh_tokens")
}

// ============== TELEGRAM LOGIN TOKENS ==============

model TelegramLoginToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique // Hashed one-time token
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("telegram_login_tokens")
}

// ============== NOTIFICATIONS ==============

model Notification {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String
  data      Json?    // Additional metadata (e.g., machineId, amount, etc.)

  // Delivery channels attempted
  channels  Json     @default("[]")  // ["in_app", "telegram"]

  // Delivery status
  readAt           DateTime? @map("read_at")
  sentToTelegramAt DateTime? @map("sent_to_telegram_at")
  telegramError    String?   @map("telegram_error")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([type])
  @@index([readAt])
  @@map("notifications")
}

enum NotificationType {
  machine_expired_soon    // Machine expires in 24h
  machine_expired         // Machine has expired
  coin_box_full          // Coin box is full (100%)
  coin_box_almost_full   // Coin box is almost full (90%)
  referral_joined        // New referral signed up
  deposit_credited       // Deposit was credited
  deposit_rejected       // Deposit was rejected by admin
  wheel_jackpot_won      // User won the jackpot
  wheel_jackpot_alert    // Someone else won the jackpot
  withdrawal_approved    // Withdrawal was approved
  withdrawal_completed   // Withdrawal was completed
  withdrawal_rejected    // Withdrawal was rejected
}

// ============== REFERRAL MILESTONES ==============

model ReferralMilestone {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  milestone String   // "5_refs", "15_refs", "50_refs", "500_refs"
  reward    String   // "free_machine_tier1", "tax_discount_5", "free_machine_tier2", "vip"
  claimedAt DateTime @default(now()) @map("claimed_at")

  @@unique([userId, milestone])
  @@index([userId])
  @@map("referral_milestones")
}
