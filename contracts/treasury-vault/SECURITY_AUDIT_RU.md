# Treasury Vault — Отчёт о безопасности и прозрачности

**Контракт:** Fortune City Treasury Vault
**Фреймворк:** Anchor 0.31.1 (Solana)
**Проведён:** Внутренний аудит безопасности
**Дата:** Февраль 2025
**Размер бинарника:** 287 KB
**Program ID (devnet):** `9brgETdzzaoxH9DcctMx7KprqpQkdDtcdQmM1y6pgDgD`

---

## Зачем этот контракт

Fortune City использует **on-chain Treasury Vault** для хранения средств игроков в виде USDT на блокчейне Solana. Это значит, что ваши депозиты хранятся не в обычной базе данных — они находятся в **публично верифицируемом смарт-контракте**, который может проверить любой желающий.

**Ключевой принцип:** Пользователи контролируют свои активы. При выводе через подключённый кошелёк пользователь сам подписывает транзакцию — средства идут напрямую из хранилища в кошелёк пользователя без посредников.

---

## 1. Обзор архитектуры

Treasury Vault — это Solana-программа (смарт-контракт), выступающая **прозрачным on-chain хранилищем** для USDT (SPL Token).

**Инструкции:** `initialize`, `deposit`, `payout`, `set_paused`, `create_withdrawal`, `claim_withdrawal`, `cancel_withdrawal`
**Стейт:** `TreasuryVault` PDA (аккаунт хранилища) + `WithdrawalRequest` PDA (запросы на вывод для каждого пользователя)
**Стандарт токенов:** SPL Token Interface (совместимость с Token и Token-2022)

### Движение средств

```
Депозит:  Игрок депонирует → On-chain token account хранилища
Вывод:    Хранилище → Кошелёк игрока (пользователь подписывает claim-транзакцию)
```

Каждый депозит, вывод и claim — это **транзакция Solana**, публично видимая в любом блокчейн-эксплорере (Solscan, Solana Explorer).

---

## 2. Защита от мошенничества

Treasury Vault спроектирован так, чтобы rug pull и присвоение средств были **структурно невозможны** на уровне смарт-контракта:

### 2.1 Нет произвольного вывода средств

В контракте нет инструкций `withdraw`, `close` или `drain`. Средства не могут быть отправлены на произвольные адреса.

- Выплаты идут **только** на зашитый payout-кошелёк, установленный при инициализации
- Вывод пользователям идёт **только** на собственный кошелёк пользователя (нужна его подпись)
- Никто — даже authority контракта — не может перенаправить средства в другое место

### 2.2 Неизменяемая конфигурация

После инициализации хранилища следующие параметры **нельзя изменить**:

- **Authority** — кто управляет хранилищем
- **Payout wallet** — куда идут операционные выплаты
- **USDT mint** — какой токен хранится
- **Token account** — какой аккаунт хранит USDT

Нет инструкций `update_authority`, `update_payout_wallet` и подобных. Это исключает все векторы "rug pull через изменение конфигурации".

### 2.3 Нет закрытия хранилища

Инструкция `close` отсутствует. Vault PDA и его token account **существуют бессрочно**. Хранилище нельзя опустошить от SOL или закрыть.

### 2.4 Неизменяемая программа

Контракт задеплоен с флагом `--final`, что делает его **неизменяемым**. Никто — включая оригинального деплоера — не может модифицировать код программы после деплоя.

---

## 3. Вывод средств — Прямой on-chain контроль

Пользователи, подключившие свой Solana-кошелёк, могут выводить USDT **напрямую из хранилища**, подписав claim-транзакцию. Это самый прозрачный метод вывода:

### Как это работает

1. **Создание запроса на вывод** — on-chain PDA записывает адрес пользователя и одобренную сумму
2. **Пользователь подписывает `claim_withdrawal`** — USDT переводятся напрямую из хранилища в token account пользователя
3. **PDA закрыт** — запрос на вывод закрывается навсегда после клейма

### Защита пользователей

| Защита | Как это работает |
|--------|-----------------|
| Только вы можете забрать свой вывод | `claim_withdrawal` требует **подпись вашего кошелька** |
| Никто не может отменить ваш активный запрос | `cancel_withdrawal` работает **только после истечения окна** |
| Гарантированное окно для клейма | У пользователя есть полное временное окно (по умолчанию: 1 час) |
| Средства идут напрямую в ваш кошелёк | USDT поступают на ваш Associated Token Account (ATA) |
| Нет двойного списания | После клейма PDA закрыт навсегда — его нельзя использовать повторно |
| On-chain доказательство | Каждый клейм — это транзакция Solana, видимая в эксплорерах |

---

## 4. Контроль доступа

| Инструкция              | Кто может вызвать      | Что делает                                     |
|------------------------|----------------------|-------------------------------------------------|
| `initialize`           | Любой (однократно)    | Создаёт хранилище (одноразовая настройка)       |
| `deposit`              | Только authority     | Вносит USDT в хранилище                         |
| `payout`               | Только authority     | Отправляет USDT на зашитый payout-кошелёк       |
| `set_paused`           | Только authority     | Экстренная пауза/снятие паузы                   |
| `create_withdrawal`    | Только authority     | Создаёт запрос на вывод для пользователя        |
| `claim_withdrawal`     | **Только пользователь** | Пользователь забирает USDT в свой кошелёк    |
| `cancel_withdrawal`    | Только authority     | Отменяет **только истекшие** запросы на вывод    |

**Ключевое:** Authority может управлять хранилищем, но **не может перенаправить средства** на любой адрес, кроме зашитого payout-кошелька или назначенных пользователей.

---

## 5. Чеклист уязвимостей

| Уязвимость                         | Статус    | Детали                                                   |
|------------------------------------|-----------|----------------------------------------------------------|
| Отсутствие проверки подписи        | БЕЗОПАСНО | Authority + User используют `Signer<'info>` корректно    |
| Отсутствие проверки владельца      | БЕЗОПАСНО | `Account<'info, T>` валидирует discriminator + owner      |
| Коллизия PDA seeds                 | БЕЗОПАСНО | Seeds включают уникальные pubkeys — коллизия невозможна   |
| Целочисленное переполнение         | БЕЗОПАСНО | `checked_add` на всех счётчиках и суммах                 |
| Реентерабельность                  | БЕЗОПАСНО | Модель исполнения Solana исключает reentrancy             |
| Произвольный CPI                   | БЕЗОПАСНО | Единственный CPI — в SPL Token через `transfer_checked`  |
| Подмена аккаунтов                  | БЕЗОПАСНО | `has_one` + `address` constraints на всех аккаунтах       |
| Чтение неинициализированного       | БЕЗОПАСНО | Anchor `Account<T>` валидирует discriminator              |
| Дубликаты мутабельных аккаунтов    | БЕЗОПАСНО | Anchor блокирует дубликаты в одной инструкции             |
| Отсутствие rent-exempt проверки    | БЕЗОПАСНО | Anchor `init` гарантирует rent exemption                  |
| Подмена token program              | БЕЗОПАСНО | `Interface<TokenInterface>` валидирует program ID          |
| Несоответствие mint                | БЕЗОПАСНО | `has_one = usdt_mint` + `transfer_checked` с decimals     |
| Revival PDA после close            | БЕЗОПАСНО | Anchor `close` ставит CLOSED_ACCOUNT_DISCRIMINATOR       |
| Double-claim withdrawal            | БЕЗОПАСНО | PDA закрыт после клейма — повторный клейм не найдёт аккаунт |
| Неавторизованный клейм             | БЕЗОПАСНО | `has_one = user` + `user: Signer` на клейме              |
| Преждевременный cancel             | БЕЗОПАСНО | Проверка expiry предотвращает cancel до дедлайна пользователя |
| Дубль withdrawal request           | БЕЗОПАСНО | PDA `init` падает если запрос уже существует               |

---

## 6. Экономическая безопасность

### 6.1 Сохранность средств

- Хранилище держит USDT в **PDA-owned token account** — ни один человек не контролирует приватный ключ
- Нет вектора flash loan — депозиты и выводы в отдельных транзакциях
- Нет зависимости от оракулов — суммы передаются как явные параметры, ценовые манипуляции невозможны
- Все переводы используют `transfer_checked` — проверка mint и decimals

### 6.2 Безопасность запросов на вывод

- **Гарантированное окно:** У пользователя есть полное время для клейма. Authority **не может отменить** активный (не истекший) запрос
- **Нет double-spend:** PDA навсегда закрывается после клейма — его нельзя переиспользовать или повторить
- **Проверка баланса:** И при создании, и при клейме проверяется достаточность баланса хранилища
- **Один запрос на пользователя:** PDA seeds гарантируют максимум один активный запрос на вывод на пользователя

### 6.3 Грифинг-векторы

- **Спам депозитами:** Только authority — третьи лица не могут влиять на хранилище
- **Фронтраннинг выплат:** Невозможен — только authority инициирует
- **Replay клейма:** PDA закрыт после клейма — `CLOSED_ACCOUNT_DISCRIMINATOR` предотвращает реактивацию
- **Спам withdrawal PDA:** Только authority создаёт — третьи лица не могут создавать PDA

---

## 7. On-chain прозрачность

### Что вы можете проверить

Каждое действие в Treasury Vault эмитирует on-chain события и создаёт верифицируемые транзакции Solana:

| Событие | Что доказывает |
|---------|---------------|
| `DepositEvent` | Средства были внесены в хранилище |
| `PayoutEvent` | Средства были отправлены на payout-кошелёк |
| `WithdrawalCreatedEvent` | Запрос на вывод создан для пользователя |
| `WithdrawalClaimedEvent` | Пользователь забрал свои средства |
| `WithdrawalCancelledEvent` | Истекший запрос на вывод был очищен |
| `VaultPausedEvent` | Хранилище приостановлено/возобновлено (только экстренные случаи) |

### Как проверить

1. **Баланс хранилища** — проверьте token account хранилища на [Solscan](https://solscan.io)
2. **История транзакций** — просмотрите все депозиты, выплаты и клеймы в любом Solana-эксплорере
3. **Код программы** — исходный код контракта открыт, задеплоенный бинарник соответствует исходникам
4. **Ваш вывод** — каждый claim_withdrawal — это подписанная Solana-транзакция в истории вашего кошелька

---

## 8. Покрытие тестами

| Тест                                     | Результат |
|------------------------------------------|-----------|
| Инициализация с корректным стейтом       | ПРОЙДЕН   |
| Отклонение повторной инициализации       | ПРОЙДЕН   |
| Депозит корректной суммы                 | ПРОЙДЕН   |
| Накопление статистики по депозитам       | ПРОЙДЕН   |
| Отклонение нулевого депозита             | ПРОЙДЕН   |
| Отклонение неавторизованного депозита    | ПРОЙДЕН   |
| Выплата на корректный кошелёк            | ПРОЙДЕН   |
| Отклонение выплаты сверх баланса         | ПРОЙДЕН   |
| Отклонение нулевой выплаты              | ПРОЙДЕН   |
| Отклонение выплаты на чужой кошелёк     | ПРОЙДЕН   |
| Пауза блокирует депозиты               | ПРОЙДЕН   |
| Пауза блокирует выплаты                | ПРОЙДЕН   |
| Снятие паузы восстанавливает работу     | ПРОЙДЕН   |
| Депозит работает после снятия паузы     | ПРОЙДЕН   |
| Отклонение неавторизованной паузы       | ПРОЙДЕН   |
| Отклонение повторной инициализации      | ПРОЙДЕН   |
| Создание запроса на вывод               | ПРОЙДЕН   |
| Отклонение дубля запроса на вывод       | ПРОЙДЕН   |
| Отклонение клейма неавторизованным юзером | ПРОЙДЕН |
| Пользователь успешно клеймит вывод      | ПРОЙДЕН   |
| Отклонение cancel до истечения          | ПРОЙДЕН   |
| Отклонение клейма после истечения       | ПРОЙДЕН   |
| Cancel истекшего запроса на вывод       | ПРОЙДЕН   |
| Отклонение создания запроса на паузе    | ПРОЙДЕН   |
| Отклонение клейма на паузе              | ПРОЙДЕН   |
| Обновление статистики после клейма      | ПРОЙДЕН   |

**26/26 тестов пройдено** (localnet)

---

## 9. Заключение

**Общий уровень риска: НИЗКИЙ**

Treasury Vault спроектирован по принципу **безопасность прежде всего, минимальная поверхность атаки**:

- **7 инструкций** со строгим контролем доступа — без бэкдоров, без админского override на клеймах пользователей
- **Неизменяемая конфигурация** — параметры хранилища нельзя изменить после инициализации
- **Неизменяемая программа** — задеплоена с флагом `--final`, код нельзя модифицировать
- **Суверенитет пользователя** — пользователи сами подписывают свои транзакции вывода
- **Полная on-chain прозрачность** — каждая транзакция публично верифицируема в Solana-эксплорерах
- **Нет механизма close/drain** — хранилище нельзя опустошить или закрыть

Контракт спроектирован так, что **даже при компрометации ключа authority** средства не могут быть перенаправлены на неавторизованные адреса. Адрес выплат зашит при инициализации, а клейм пользователя требует подпись его собственного кошелька.

Treasury Vault Fortune City обеспечивает тот же уровень прозрачности и контроля, который вы ожидаете от DeFi-протокола — ваши средства на блокчейне, верифицируемы и доступны через ваш собственный кошелёк.
